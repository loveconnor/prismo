<app-dialog
  [open]="open"
  (openChange)="openChange.emit($event)"
  [className]="dialogClasses"
  [closeOnBackdropClick]="true"
>
  <div>
    <app-dialog-header [className]="'space-y-0'">
      <div class="modal-header">
        <div class="icon-pill">
          <ng-icon name="lucide-sparkles" class="h-5 w-5"></ng-icon>
        </div>
        <div class="flex-1">
          <app-dialog-title [className]="titleClasses">Generate a New Lab</app-dialog-title>
          <app-dialog-description [className]="descriptionClasses">
            Customize your learning experience by selecting a subject, difficulty, and focus areas.
          </app-dialog-description>
        </div>
      </div>
    </app-dialog-header>

    <div class="modal-body">
      <div class="field-group">
        <app-label for="subject" [className]="labelClasses">
          Choose a subject <span class="required">*</span>
        </app-label>
        <app-select
          id="subject"
          name="subject"
          [options]="subjects"
          [className]="selectTriggerClasses"
          [contentClassName]="selectContentClasses"
          [optionClassName]="selectOptionClasses"
          [placeholder]="'Select subject…'"
          [(ngModel)]="subject"
        ></app-select>
      </div>

      <div class="field-group">
        <app-label for="difficulty" [className]="labelClasses">
          Select difficulty <span class="required">*</span>
        </app-label>
        <app-select
          id="difficulty"
          name="difficulty"
          [options]="difficulties"
          [className]="selectTriggerClasses"
          [contentClassName]="selectContentClasses"
          [optionClassName]="selectOptionClasses"
          [placeholder]="'Choose difficulty…'"
          [(ngModel)]="difficulty"
        ></app-select>
      </div>

      <div class="field-group">
        <app-label for="skills" [className]="labelClasses">
          What skills do you want to practice?
        </app-label>
        <div class="flex gap-2">
          <app-input
            id="skills"
            name="skills"
            [ngModel]="skillInput"
            (ngModelChange)="onSkillInputChange($event)"
            (keydown)="handleSkillKeydown($event)"
            (blur)="handleSkillInputBlur()"
            placeholder="Add skill then press enter (e.g., loops, debugging, recursion)"
            [className]="inputClasses"
            class="flex-1"
          ></app-input>
          <button
            type="button"
            (click)="addSkill()"
            [disabled]="!skillInput.trim()"
            class="px-4 py-2 text-sm font-medium rounded whitespace-nowrap transition-colors"
            [style.backgroundColor]="skillInput.trim() ? '#3b82f6' : '#e5e7eb'"
            [style.color]="skillInput.trim() ? '#fff' : '#9ca3af'"
            [style.borderColor]="skillInput.trim() ? '#1e40af' : '#d1d5db'"
            [style.border]="'1px solid'"
            [style.cursor]="skillInput.trim() ? 'pointer' : 'not-allowed'"
          >
            Add Skill
          </button>
        </div>

        @if (skills.length > 0) {
          <div class="skills-list">
            @for (skill of skills; track i; let i = $index) {
              <span class="skill-pill">
                {{ skill }}
                <button type="button" (click)="removeSkill(i)" class="ml-1 hover:opacity-70">
                  <ng-icon name="lucide-x" class="h-3 w-3"></ng-icon>
                </button>
              </span>
            }
          </div>
        }

        <p class="helper-text">Optional — helps the AI personalize your lab. Press Enter or click "Add Skill" to add.</p>
      </div>

      <div class="field-group">
        <app-label for="goal" [className]="labelClasses">
          Describe your focus area (optional)
        </app-label>
        <app-textarea
          id="goal"
          name="goal"
          [ngModel]="goal"
          (ngModelChange)="onGoalChange($event)"
          placeholder="e.g., I want to get better at debugging for-loops"
          [rows]="3"
          [className]="textareaClasses"
        ></app-textarea>
      </div>
    </div>

    <app-dialog-footer class="footer">
      <app-button 
        (click)="submit()" 
        [disabled]="!canSubmit || isGenerating" 
        [className]="buttonClasses"
      >
        <ng-icon name="lucide-sparkles" class="h-4 w-4"></ng-icon>
        {{ isGenerating ? 'Generating...' : 'Generate Lab' }}
      </app-button>
    </app-dialog-footer>
  </div>
</app-dialog>

<!-- Loading Screen -->
<app-module-loading-screen
  [isLoading]="isGenerating"
  [title]="'Generating Your Lab'"
  [message]="'Our AI is crafting a personalized learning experience just for you...'"
  [progress]="loadingProgress"
  [progressText]="loadingProgressText"
></app-module-loading-screen>
