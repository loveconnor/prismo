<div
  cdkOverlayOrigin
  #origin="cdkOverlayOrigin"
  class="inline-flex w-full"
>
  <!-- Trigger Button -->
  <button
    #triggerRef
    type="button"
    [class]="triggerClasses"
    [disabled]="disabled"
    [attr.aria-expanded]="isOpen"
    [attr.aria-haspopup]="true"
    role="combobox"
    (click)="toggle()"
  >
    <span class="flex items-center gap-2">
      <span [class]="selectedValue ? 'text-foreground' : 'text-muted-foreground'">
        {{ selectedLabel }}
      </span>
    </span>
    <svg
      class="size-4 opacity-50 transition-transform duration-200"
      [class.rotate-180]="isOpen"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>
</div>

<ng-template
  cdkConnectedOverlay
  [cdkConnectedOverlayOrigin]="origin"
  [cdkConnectedOverlayOpen]="isOpen"
  [cdkConnectedOverlayPositions]="overlayPositions"
  [cdkConnectedOverlayOffsetY]="overlayOffsetY"
  [cdkConnectedOverlayPush]="true"
  [cdkConnectedOverlayHasBackdrop]="true"
  [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'"
  [cdkConnectedOverlayWidth]="triggerWidth"
  (backdropClick)="close()"
  (overlayOutsideClick)="close()"
  (detach)="close()"
>
  <div
    #contentRef
    [class]="contentClasses"
    role="listbox"
    [attr.aria-labelledby]="triggerRef?.id"
    [attr.data-state]="isOpen ? 'open' : 'closed'"
    [attr.data-side]="'bottom'"
  >
    @for (option of options; track option.value) {
      <button
        type="button"
        [class]="optionClasses"
        [disabled]="option.disabled"
        [attr.data-value]="option.value"
        [attr.data-selected]="isSelected(option.value)"
        role="option"
        [attr.aria-selected]="isSelected(option.value)"
        (click)="selectOption(option.value)"
      >
        @if (isSelected(option.value)) {
          <svg
            class="absolute left-2 top-1/2 -translate-y-1/2 size-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        }
        <span class="truncate">{{ option.label }}</span>
      </button>
    }
  </div>
</ng-template>

<!-- Hidden select for form compatibility -->
<select
  [class]="'hidden'"
  [disabled]="disabled"
  [value]="selectedValue"
  (change)="onSelectionChange($any($event.target).value)"
>
  <option value="" disabled>{{ placeholder }}</option>
  @for (option of options; track option.value) {
    <option [value]="option.value" [disabled]="option.disabled">
      {{ option.label }}
    </option>
  }
</select>
