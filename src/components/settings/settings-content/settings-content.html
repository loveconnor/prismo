<div class="settings-content">
  <div class="settings-content__inner" [ngSwitch]="activeSection">
    <ng-container *ngSwitchCase="'profile'">
      <app-settings-section title="Profile">
        <app-settings-row
          label="Profile picture"
          description="Upload a photo to personalize your account."
        >
          <div class="flex items-center gap-4">
            <div class="relative">
              <img 
                [src]="avatarUrl || 'https://hacksu.com//staff-photos/beautiful_mason.png_1747039062046.png'" 
                alt="Profile picture"
                class="w-16 h-16 rounded-full object-cover border-2"
                [class.border-zinc-700]="isDark"
                [class.border-zinc-200]="!isDark"
              >
            </div>
            <div class="flex flex-col gap-2">
              <input 
                #fileInput
                type="file" 
                accept="image/*"
                (change)="onFileSelected($event)"
                class="hidden"
              >
              <app-button
                type="button"
                variant="outline"
                [className]="uploadButtonClasses"
                (click)="fileInput.click()"
              >
                Upload photo
              </app-button>
              @if (avatarUrl) {
                <app-button
                  type="button"
                  variant="ghost"
                  [className]="removeButtonClasses"
                  (click)="removeAvatar()"
                >
                  Remove
                </app-button>
              }
            </div>
          </div>
        </app-settings-row>

        <app-settings-row
          label="Display name"
          description="This name appears on your shared labs and profile."
        >
          <app-input
            [(ngModel)]="displayName"
            (ngModelChange)="onDisplayNameChange($event)"
            placeholder="Enter name"
            [className]="controlInputClasses"
          ></app-input>
        </app-settings-row>

        <app-settings-row
          label="Time zone"
          description="Adjust for accurate due times and review schedules."
        >
          <app-select
            [(ngModel)]="timeZone"
            [options]="timeZoneOptions"
            [className]="selectTriggerClasses"
            [contentClassName]="selectContentClasses"
            [optionClassName]="selectOptionClasses"
            (selectionChange)="onTimeZoneChange($event)"
          ></app-select>
        </app-settings-row>
      </app-settings-section>
    </ng-container>

    <ng-container *ngSwitchCase="'appearance'">
      <app-settings-section title="Appearance">
        <app-settings-row
          label="Theme"
          description="Choose how Prismo Labs looks across devices."
        >
          <app-select
            [(ngModel)]="themeMode"
            [options]="themeOptions"
            [className]="selectTriggerClasses"
            [contentClassName]="selectContentClasses"
            [optionClassName]="selectOptionClasses"
            (selectionChange)="onThemeChange($event)"
          ></app-select>
        </app-settings-row>

        <app-settings-row
          label="Font family"
          [description]="fontLoadingStatus.isLoading ? 
            'Detecting available fonts... (' + fontLoadingStatus.availableCount + '/' + fontLoadingStatus.totalCount + ' found)' : 
            'Choose your preferred typeface for reading and coding.'"
        >
          <app-select
            [(ngModel)]="fontFamily"
            [options]="fontFamilyOptions"
            [className]="selectTriggerClasses"
            [contentClassName]="selectContentClasses"
            [optionClassName]="selectOptionClasses"
            [disabled]="fontLoadingStatus.isLoading"
            (selectionChange)="onFontFamilyChange($event)"
          ></app-select>
        </app-settings-row>

        <app-settings-row
          label="Interface text size"
          description="Adjust type scale for comfort during longer sessions."
        >
          <app-select
            [(ngModel)]="fontSize"
            [options]="fontSizeOptions"
            [className]="selectTriggerClasses"
            [contentClassName]="selectContentClasses"
            [optionClassName]="selectOptionClasses"
            (selectionChange)="onFontSizeChange($event)"
          ></app-select>
        </app-settings-row>
      </app-settings-section>
    </ng-container>

    <ng-container *ngSwitchCase="'notifications'">
      <app-settings-section title="Notifications">
        <app-settings-row
          label="Email progress updates"
          description="Receive weekly summaries of your skill growth."
        >
          <app-switch
            [(ngModel)]="emailProgress"
            [className]="'data-[state=checked]:bg-[#BC78F9]'"
          ></app-switch>
        </app-settings-row>

        <app-settings-row
          label="Remind me when I get stuck"
          description="Notify me if I haven't completed a lab step in 3 days."
        >
          <app-switch
            [(ngModel)]="reminderHints"
            [className]="'data-[state=checked]:bg-[#BC78F9]'"
          ></app-switch>
        </app-settings-row>
      </app-settings-section>
    </ng-container>

    <ng-container *ngSwitchCase="'adaptive'">
      <app-settings-section title="Adaptive Learning">
        <app-settings-row
          label="Adjust difficulty automatically"
          description="The system will tailor labs based on your mastery and confidence ratings."
        >
          <app-switch
            [(ngModel)]="autoDifficulty"
            [className]="'data-[state=checked]:bg-[#BC78F9]'"
          ></app-switch>
        </app-settings-row>

        <app-settings-row
          label="Show skill mastery map"
          description="Visualize your current progress using color-coded topics."
        >
          <app-switch
            [(ngModel)]="showMasteryMap"
            [className]="'data-[state=checked]:bg-[#BC78F9]'"
          ></app-switch>
        </app-settings-row>
      </app-settings-section>

      <app-settings-section title="Danger Zone" variant="danger">
        <app-settings-row
          label="Delete all progress data"
          description="Erase all lab attempts and mastery tracking while keeping your account intact."
        >
          <app-button
            type="button"
            variant="destructive"
            [className]="'w-56 bg-[#dc2626] text-white hover:bg-[#b91c1c] shadow-[0_0_0_1px_rgba(220,38,38,0.2)]'"
            (click)="openDeleteConfirmation()"
          >
            Delete progress
          </app-button>
        </app-settings-row>
      </app-settings-section>
    </ng-container>

    <ng-container *ngSwitchCase="'privacy'">
      <div class="settings-content__coming-soon">
        <p>This section is coming soon.</p>
      </div>
    </ng-container>

    <ng-container *ngSwitchCase="'security'">
      <div class="settings-content__coming-soon">
        <p>This section is coming soon.</p>
      </div>
    </ng-container>

    <ng-container *ngSwitchCase="'progress'">
      <div class="settings-content__coming-soon">
        <p>This section is coming soon.</p>
      </div>
    </ng-container>

    <ng-container *ngSwitchCase="'curriculum'">
      <div class="settings-content__coming-soon">
        <p>This section is coming soon.</p>
      </div>
    </ng-container>
    
    <ng-container *ngSwitchCase="'code-execution'">
      <app-settings-section title="Custom Libraries">
        <app-settings-row
          label="Upload library files"
          description="Upload JAR files, Python packages, or other dependencies to use in code labs."
        >
          <div class="flex flex-col gap-3 w-full">
            <!-- Language selector and upload button -->
            <div class="flex items-center gap-2 flex-wrap">
              <app-select
                [(ngModel)]="selectedLanguage"
                [options]="languageOptions"
                className="w-36 bg-zinc-800 border-zinc-700 text-zinc-200"
                [contentClassName]="selectContentClasses"
                [optionClassName]="selectOptionClasses"
                (selectionChange)="onLanguageChange($event)"
              ></app-select>
              
              <input 
                #libraryFileInput
                type="file" 
                (change)="onLibraryFileSelected($event)"
                class="hidden"
              >
              <app-button
                type="button"
                variant="outline"
                [className]="uploadButtonClasses"
                [disabled]="uploadingLibrary"
                (click)="libraryFileInput.click()"
              >
                @if (uploadingLibrary) {
                  <span>Uploading...</span>
                } @else {
                  <span>Upload Library</span>
                }
              </app-button>
            </div>
            
            <!-- Libraries list -->
            @if (getLibrariesForLanguage(selectedLanguage).length > 0) {
              <div class="space-y-2 mt-2 max-h-[300px] overflow-y-auto pr-2">
                @for (lib of getLibrariesForLanguage(selectedLanguage); track lib.id) {
                  <div 
                    class="flex items-center justify-between p-3 rounded-lg border"
                    [class.bg-zinc-800]="isDark"
                    [class.border-zinc-700]="isDark"
                    [class.bg-white]="!isDark"
                    [class.border-zinc-200]="!isDark"
                  >
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                      <app-switch
                        [(ngModel)]="lib.enabled"
                        (ngModelChange)="toggleLibraryEnabled(lib)"
                        [className]="'data-[state=checked]:bg-[#BC78F9]'"
                      ></app-switch>
                      
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <p 
                            class="font-medium text-sm truncate"
                            [class.text-zinc-200]="isDark"
                            [class.text-zinc-900]="!isDark"
                          >
                            {{ lib.filename }}
                          </p>
                          <span 
                            class="text-xs px-1.5 py-0.5 rounded"
                            [class.bg-blue-500/20]="isDark"
                            [class.text-blue-300]="isDark"
                            [class.bg-blue-100]="!isDark"
                            [class.text-blue-700]="!isDark"
                          >
                            {{ lib.language }}
                          </span>
                        </div>
                        <p 
                          class="text-xs mt-0.5"
                          [class.text-zinc-400]="isDark"
                          [class.text-zinc-600]="!isDark"
                        >
                          {{ formatFileSize(lib.size) }} • Uploaded {{ lib.uploadedAt | date:'short' }}
                        </p>
                      </div>
                    </div>
                    
                    <app-button
                      type="button"
                      variant="ghost"
                      [className]="'text-red-400 hover:text-red-300 hover:bg-red-500/10 px-2'"
                      (click)="deleteLibrary(lib)"
                    >
                      <span class="text-sm">Delete</span>
                    </app-button>
                  </div>
                }
              </div>
            } @else {
              <p 
                class="text-sm text-center py-4"
                [class.text-zinc-400]="isDark"
                [class.text-zinc-500]="!isDark"
              >
                No custom libraries uploaded yet. Upload a library file to get started.
              </p>
            }
          </div>
        </app-settings-row>
        
        <app-settings-row
          label="How it works"
          description="Custom libraries are automatically included when compiling and running code in labs."
        >
          <div 
            class="text-xs p-3 rounded-lg w-full"
            [class.bg-zinc-800]="isDark"
            [class.text-zinc-300]="isDark"
            [class.bg-zinc-50]="!isDark"
            [class.text-zinc-700]="!isDark"
          >
            <ul class="space-y-1.5 list-disc list-inside">
              <li><strong>Java:</strong> JAR files added to classpath</li>
              <li><strong>Python:</strong> Modules available for import</li>
              <li><strong>JavaScript:</strong> Packages via require/import</li>
              <li><strong>C++:</strong> Libraries linked during compilation</li>
            </ul>
          </div>
        </app-settings-row>
      </app-settings-section>
    </ng-container>
  </div>

  <app-confirm-dialog
    [open]="showDeleteDialog"
    (openChange)="showDeleteDialog = $event"
    title="Delete all progress data?"
    description="This action cannot be undone. All your lab attempts, mastery tracking, and progress data will be permanently deleted."
    confirmLabel="Delete progress"
    cancelLabel="Cancel"
    variant="danger"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteConfirmation()"
  ></app-confirm-dialog>
</div>
